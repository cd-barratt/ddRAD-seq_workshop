---
title: 'Tutorial: Admixture'
output:
  html_document: default
  word_document: default
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, eval = FALSE,
                      echo=TRUE, warning=FALSE, message=FALSE,
                      tidy = TRUE, collapse = TRUE,
                      results = 'hold')
```
\
\

### Timings 
  1. Run admixture (in EVE cluster, ~3 min)
  2. Initial setup and package install (< 1 min)
  3. Load data (< 1 min)
  4. Plot CV scores (< 1 min)
  5. Make barplot of Admixture results (< 1 min)

Step 1 done in EVE cluster, Steps 2-4 done locally on your machines
  
\
\

### Other info
- If you are on a PC, directory paths need to be separated by back-slashes instead of forward-slashes
- Try not to resize windows/display panels while R is busy calculating/plotting - this tends to cause problems
  
\
\

### 1. Run Admixture (on the EVE cluster)
#This is all done in the EVE cluster, you can make your own scripts to do this or use the one provided #(run_Admixture.sh). It can be submitted via sbatch in the EVE cluster, but be sure to modify the email address #and output paths to your own details.

```{r}
#!/bin/bash                                                                                                                            
#SBATCH --job-name=Admixture
#SBATCH --mail-user=christopher_david.barratt@uni-leipzig.de
#SBATCH --mail-type=BEGIN,END,FAIL,TIME_LIMIT
#SBATCH --output=/work/barratt/Workshop_3/job_logs/%x-%j.log
#SBATCH --cpus-per-task=1
#SBATCH --mem-per-cpu=15G
#SBATCH --time=4:00:00

#load environment
module purge
module load Anaconda3
conda activate /global/apps/plink_1.90

# Converting ped and map files to bed format for Admixture
plink --file ~/work/Workshop_3/Leptopelis_flavomaculatus/Inputs/Admixture/Lflav --make-bed --recode --out ~/work/Workshop_3/Leptopelis_flavomaculatus/Outputs/Admixture/Lflav

#run admixture#run admixture
cd ~/work/Workshop_3/Leptopelis_flavomaculatus/Outputs/Admixture
bash
conda activate /gpfs0/global/apps/stacks_2.61
for K in 1 2 3 4 5 6 7 8 9 10; \
do admixture --cv=10 ./Lflav.bed $K| tee log_Lflav.${K}.out; done

# grep to combine all results
grep -h CV log_Lflav*.out > ./RESULTS_Leptopelis_flavomaculatus_admixture.txt

#sed to clean results for later analysis
sed -e 's/CV error (K=//g' ./RESULTS_Leptopelis_flavomaculatus_admixture.txt | sed 's/)://g' > ./RESULTS_Leptopelis_flavomaculatus_admixture_clean.txt

# replace all single digit numbers to begin with 0s for numerical sorting
sed -e 's/1 /01 /g' ./RESULTS_Leptopelis_flavomaculatus_admixture_clean.txt \
| sed -e 's/2 /02 /g' \
| sed -e 's/3 /03 /g' \
| sed -e 's/4 /04 /g' \
| sed -e 's/5 /05 /g' \
| sed -e 's/6 /06 /g' \
| sed -e 's/7 /07 /g' \
| sed -e 's/8 /08 /g' \
| sed -e 's/9 /09 /g'> ./tmp.txt\

# sort output file (01-10) and remove old temporary one
sort ./tmp.txt > ./RESULTS_Leptopelis_flavomaculatus_admixture_clean.txt
rm -rf ./tmp.txt
```

\
\

### 2. Initial setup and package install (in R)
Now we are switching to R to make sense of the Admixture output files...
The following block of code will install all required R packages for this tutorial, you can copy and paste this in your R Studio and run it. All of this code works with the latest R version (4.1.0), and possibly older ones (e.g. 3.5.0), but I cannot guarantee it will work, so best to have R v.4.1.0.

```{r}
rm(list=ls(all=TRUE))

setwd('./data/L_flavomaculatus/Outputs/Admixture/')

#install.packages(c('stringr'))

library(stringr)
```

\
\

### 3. Load data
Load the cleaned Admixture output file that we will analyse. This is a simple text file with the number of clusters (K) and the corresponding 10-fold cross-validation(CV) score

```{r}
results <- read.delim('./data/L_flavomaculatus/Outputs/Admixture/RESULTS_Leptopelis_flavomaculatus_admixture_clean.txt', sep=' ',header=FALSE)
```

\
\

### 4. Plot CV scores
We will first set the plot margins and then set an output file (png) with specific sizes and resolutions
Then we plot the results (first points, then a line to join the points)

```{r}
par(mar=c(2,2,2,2))
png(filename="./outputs/Admixture_Results_CV_scores.png", type="quartz", height=8, width=8, units="in", res=300)
plot (results, pch=19, col= "black", cex=0.25, xlab="k clusters", ylab="CV score", main = "Cross validation scores across k (Admixture")
lines(results, lty=1, lwd=1.5, col='steelblue2')
dev.off()
```

Because this dataset is for relatively highly structured (low-dispersal) amphibians, the 'elbow' in the plot is very clear - with a lower CV score at K=4. This is not always the case for all datasets, so other approaches might be useful to use a few different methods to look at population structure (reviewers anyway generally like this approach).

\
\

### 5. Make barplot of Admixture results
Now that we know the optimal value of K we can plot the Admixture coefficients across all of our samples (n=59 in this case). We'll read the Lflav.4.Q output file from Admixture and order it to make it look nicer. We'll then plot it, add individual labels for each sample and then save the final plot.

```{r}
# plot bars
tbl=read.table("./data/L_flavomaculatus/Outputs/Admixture/Lflav.4.Q")
ord = tbl[order(tbl$V1,tbl$V3,tbl$V2,tbl$V4),]
png(filename="./outputs/Admixture_Results_Barplot.png", type="quartz", height=8, width=30, units="in", res=300)
labels <-read.csv("./data/L_flavomaculatus/Inputs/Admixture/pop_labels.csv", header=FALSE)
labels <- data.frame(labels[,1])
ord_with_labels <- data.frame(ord[,1:4], row.names=labels[,1])
par(mar=c(20,4,1,1))
bp = barplot(t(as.matrix(ord_with_labels)), space = (0.04), col=c("blue", "turquoise", "darkblue", "lightblue"), xlab="", ylab="Ancestry", border=1, las=2, cex.names=0.9)
dev.off()

```

\
\

### On your own...

Try plotting k=1 - k=5, feel free to change colour schemes and the order of the tbl object
If you have your own data you can try and use this script to plot your own outputs
